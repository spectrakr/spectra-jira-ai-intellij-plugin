name: Release Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle wrapper
      uses: actions/cache@v4
      with:
        path: ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-wrapper-

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/daemon
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

#    - name: Run tests
#      run: ./gradlew test

    - name: Build plugin
      run: ./gradlew buildPlugin

    - name: Verify plugin
      run: ./gradlew verifyPlugin

    - name: Prepare plugin repository
      run: ./gradlew preparePluginRepository

    - name: Get version and tag
      id: get_version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "tag_name=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=v${VERSION}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## ì´ë²ˆ ë¦´ë¦¬ìŠ¤ì˜ ë³€ê²½ì‚¬í•­
          
          - í”ŒëŸ¬ê·¸ì¸ ë²„ì „: ${{ steps.get_version.outputs.version }}
          - IntelliJ IDEA ë¹Œë“œ 233 ~ 242.* ë²„ì „ê³¼ í˜¸í™˜
          
          ### ì„¤ì¹˜ ë°©ë²• (ìë™ ì—…ë°ì´íŠ¸ ì§€ì›)
          
          1. IntelliJ IDEAë¥¼ ì—´ê³  `File â†’ Settings â†’ Plugins`ë¡œ ì´ë™
          2. âš™ï¸ í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ â†’ `Manage Plugin Repositories` í´ë¦­
          3. `+` ë²„íŠ¼ì„ í´ë¦­í•˜ê³  ë‹¤ìŒ URLì„ ì¶”ê°€:
             ```
             https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/updatePlugins.xml
             ```
          4. `OK` í´ë¦­
          5. `Marketplace` íƒ­ì—ì„œ "Spectra Jira AI" ê²€ìƒ‰ í›„ ì„¤ì¹˜
          
          ### ì„¤ì • ë°©ë²•
          ì„¤ì¹˜ í›„ `File â†’ Settings â†’ Tools â†’ Spectra Jira Settings`ì—ì„œ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì •í•˜ì„¸ìš”.
        draft: false
        prerelease: false
        files: |
          ./build/distributions/*.zip

    - name: Prepare GitHub Pages
      run: |
        mkdir -p gh-pages
        cp build/repository/updatePlugins.xml gh-pages/
        
        # Create index.html for repository info
        cat > gh-pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Spectra Jira AI IntelliJ í”ŒëŸ¬ê·¸ì¸ ì €ì¥ì†Œ</title>
            <meta charset="utf-8">
            <style>
                body { font-family: 'Malgun Gothic', Arial, sans-serif; margin: 40px; line-height: 1.6; }
                .container { max-width: 800px; margin: 0 auto; }
                code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; font-family: 'Monaco', 'Consolas', monospace; }
                .url { background: #e8f4fd; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0; border-left: 4px solid #2196F3; }
                .highlight { background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107; }
                h1 { color: #2196F3; }
                h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
                .method { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
                .note { background: #d4edda; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745; margin: 15px 0; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸš€ Spectra Jira AI IntelliJ í”ŒëŸ¬ê·¸ì¸ ì €ì¥ì†Œ</h1>
                
                <div class="highlight">
                    <strong>ğŸ“Œ ìµœì‹  ë²„ì „:</strong> ${{ steps.get_version.outputs.version }}
                </div>
                
                <div class="note">
                    <strong>ğŸ’¡ ê¶Œì¥ ì„¤ì¹˜ ë°©ë²•:</strong> ìë™ ì—…ë°ì´íŠ¸ë¥¼ ì§€ì›í•˜ëŠ” ì»¤ìŠ¤í…€ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                </div>
                
                <h2>ğŸ”§ ì„¤ì¹˜ ë°©ë²•</h2>
                
                <div class="method">
                    <h3>ì»¤ìŠ¤í…€ ì €ì¥ì†Œ ë°©ì‹ (ìë™ ì—…ë°ì´íŠ¸ ì§€ì›)</h3>
                    <ol>
                        <li>IntelliJ IDEAë¥¼ ì—´ê³  <code>File â†’ Settings â†’ Plugins</code>ë¡œ ì´ë™</li>
                        <li>âš™ï¸ í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ì„ í´ë¦­í•˜ê³  <code>Manage Plugin Repositories</code> ì„ íƒ</li>
                        <li><code>+</code> ë²„íŠ¼ì„ í´ë¦­í•˜ê³  ë‹¤ìŒ URLì„ ì¶”ê°€:</li>
                    </ol>
                    
                    <div class="url">
                        https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/updatePlugins.xml
                    </div>
                    
                    <ol start="4">
                        <li><code>OK</code> ë²„íŠ¼ í´ë¦­</li>
                        <li><code>Marketplace</code> íƒ­ì—ì„œ <strong>"Spectra Jira AI"</strong> ê²€ìƒ‰</li>
                        <li><code>Install</code> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„¤ì¹˜</li>
                        <li>IntelliJ IDEA ì¬ì‹œì‘</li>
                    </ol>
                </div>
                
                <h2>ğŸ”„ ìë™ ì—…ë°ì´íŠ¸</h2>
                <p>ì»¤ìŠ¤í…€ ì €ì¥ì†Œ ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ í”ŒëŸ¬ê·¸ì¸ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•˜ê³  ìƒˆ ë²„ì „ì´ ìˆì„ ë•Œ ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤. IntelliJì˜ í”ŒëŸ¬ê·¸ì¸ ê´€ë¦¬ìì—ì„œ ì—…ë°ì´íŠ¸ ì•Œë¦¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                
                <h2>âš™ï¸ ì„¤ì • ë°©ë²•</h2>
                <p>ì„¤ì¹˜ í›„ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì •í•˜ì„¸ìš”:</p>
                <ol>
                    <li><code>File â†’ Settings â†’ Tools â†’ Spectra Jira Settings</code>ë¡œ ì´ë™</li>
                    <li>Jira ì„œë²„ URL, ì‚¬ìš©ìëª…, API í† í°ì„ ì…ë ¥</li>
                    <li>ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ê³  ì €ì¥</li>
                </ol>
                
                <h2>ğŸ”— ë§í¬</h2>
                <ul>
                    <li><a href="https://github.com/${{ github.repository }}">ğŸ“‚ GitHub ì €ì¥ì†Œ</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/releases">ğŸ“¦ ëª¨ë“  ë¦´ë¦¬ìŠ¤</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/issues">ğŸ› ë¬¸ì œ ì‹ ê³ </a></li>
                    <li><a href="https://github.com/${{ github.repository }}/blob/main/README.md">ğŸ“– ë¬¸ì„œ</a></li>
                </ul>
                
                <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #666; text-align: center;">
                    <p>Spectra Teamì—ì„œ â¤ï¸ìœ¼ë¡œ ì œì‘ | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${{ steps.get_version.outputs.version }}</p>
                </footer>
            </div>
        </body>
        </html>
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v3
      with:
        enablement: true

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: gh-pages

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

#    - name: Publish to JetBrains Marketplace
#      if: ${{ secrets.PUBLISH_TOKEN }}
#      run: ./gradlew publishPlugin
#      env:
#        PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
