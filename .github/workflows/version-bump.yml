name: Version Bump and Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      custom_version:
        description: 'Custom version (optional, overrides version_type)'
        required: false
        type: string

jobs:
  version-bump-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Get current version
      id: current_version
      run: |
        CURRENT_VERSION=$(grep "^version = " build.gradle | sed "s/version = '//" | sed "s/'//")
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

    - name: Calculate new version
      id: new_version
      run: |
        CURRENT="${{ steps.current_version.outputs.current }}"
        
        if [ -n "${{ github.event.inputs.custom_version }}" ]; then
          NEW_VERSION="${{ github.event.inputs.custom_version }}"
          echo "Using custom version: $NEW_VERSION"
        else
          # Parse current version (assuming semantic versioning: x.y.z)
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          case "${{ github.event.inputs.version_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "Bumped ${{ github.event.inputs.version_type }} version: $NEW_VERSION"
        fi
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Update version in build.gradle
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.version }}"
        sed -i "s/^version = .*/version = '$NEW_VERSION'/" build.gradle
        echo "Updated build.gradle to version: $NEW_VERSION"

    - name: Update CHANGELOG.md
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.version }}"
        TODAY=$(date +%Y-%m-%d)
        
        # Create or update CHANGELOG.md
        if [ ! -f CHANGELOG.md ]; then
          cat > CHANGELOG.md << EOF
# Changelog

All notable changes to the Spectra IntelliJ AI Plugin will be documented in this file.

## [${NEW_VERSION}] - ${TODAY}

### Added
- Version ${NEW_VERSION} release

EOF
        else
          # Insert new version at the top of existing changelog
          sed -i "/^## \\[Unreleased\\]/a\\
\\
## [${NEW_VERSION}] - ${TODAY}\\
\\
### Added\\
- Version ${NEW_VERSION} release\\
" CHANGELOG.md
        fi

    - name: Commit version bump
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.version }}"
        git add build.gradle CHANGELOG.md
        git commit -m "🔖 Bump version to ${NEW_VERSION}
        
        - Updated build.gradle version
        - Updated CHANGELOG.md
        - Automated version bump via GitHub Actions"
        
        git push origin main

    - name: Create and push tag
      run: |
        TAG="${{ steps.new_version.outputs.tag }}"
        git tag -a "$TAG" -m "Release $TAG"
        git push origin "$TAG"

    - name: Cache Gradle wrapper
      uses: actions/cache@v4
      with:
        path: ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle-wrapper.properties') }}

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/daemon
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build plugin
      run: ./gradlew buildPlugin

    - name: Verify plugin
      run: ./gradlew verifyPlugin

    - name: Prepare plugin repository
      run: ./gradlew preparePluginRepository

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.new_version.outputs.tag }}
        name: Release ${{ steps.new_version.outputs.version }}
        body: |
          ## 🎉 버전 ${{ steps.new_version.outputs.version }} 릴리스
          
          - 플러그인 버전: ${{ steps.new_version.outputs.version }}
          - IntelliJ IDEA 빌드 233 ~ 242.* 버전과 호환
          - 자동 업데이트 지원
          
          ### 📥 설치 방법 (자동 업데이트 지원)
          
          1. IntelliJ IDEA를 열고 `File → Settings → Plugins`로 이동
          2. ⚙️ 톱니바퀴 아이콘 → `Manage Plugin Repositories` 클릭
          3. `+` 버튼을 클릭하고 다음 URL을 추가:
             ```
             https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/updatePlugins.xml
             ```
          4. `OK` 클릭
          5. `Marketplace` 탭에서 "Spectra Jira AI" 검색 후 설치
          
          ### ⚙️ 설정 방법
          설치 후 `File → Settings → Tools → Spectra Jira Settings`에서 플러그인을 설정하세요.
          
          ### 🔄 자동 업데이트
          커스텀 저장소를 추가한 사용자는 IntelliJ에서 자동으로 업데이트 알림을 받게 됩니다.
        draft: false
        prerelease: false
        files: |
          ./build/distributions/*.zip

    - name: Prepare GitHub Pages
      run: |
        mkdir -p gh-pages
        cp build/repository/updatePlugins.xml gh-pages/
        
        # Create index.html for repository info
        cat > gh-pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Spectra Jira AI IntelliJ 플러그인 저장소</title>
            <meta charset="utf-8">
            <style>
                body { font-family: 'Malgun Gothic', Arial, sans-serif; margin: 40px; line-height: 1.6; }
                .container { max-width: 800px; margin: 0 auto; }
                code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; font-family: 'Monaco', 'Consolas', monospace; }
                .url { background: #e8f4fd; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0; border-left: 4px solid #2196F3; }
                .highlight { background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107; }
                h1 { color: #2196F3; }
                h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
                .method { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
                .note { background: #d4edda; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745; margin: 15px 0; }
                .update-info { background: #e3f2fd; padding: 15px; border-radius: 5px; border-left: 4px solid #2196f3; margin: 15px 0; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>🚀 Spectra Jira AI IntelliJ 플러그인 저장소</h1>
                
                <div class="highlight">
                    <strong>📌 최신 버전:</strong> ${{ steps.new_version.outputs.version }}
                </div>
                
                <div class="update-info">
                    <strong>🔄 자동 업데이트 활성화!</strong><br>
                    아래 방법으로 설치하면 새 버전이 출시될 때마다 IntelliJ에서 자동으로 알림을 받습니다.
                </div>
                
                <div class="note">
                    <strong>💡 권장 설치 방법:</strong> 자동 업데이트를 지원하는 커스텀 저장소를 사용하세요.
                </div>
                
                <h2>🔧 설치 방법</h2>
                
                <div class="method">
                    <h3>커스텀 저장소 방식 (자동 업데이트 지원)</h3>
                    <ol>
                        <li>IntelliJ IDEA를 열고 <code>File → Settings → Plugins</code>로 이동</li>
                        <li>⚙️ 톱니바퀴 아이콘을 클릭하고 <code>Manage Plugin Repositories</code> 선택</li>
                        <li><code>+</code> 버튼을 클릭하고 다음 URL을 추가:</li>
                    </ol>
                    
                    <div class="url">
                        https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/updatePlugins.xml
                    </div>
                    
                    <ol start="4">
                        <li><code>OK</code> 버튼 클릭</li>
                        <li><code>Marketplace</code> 탭에서 <strong>"Spectra Jira AI"</strong> 검색</li>
                        <li><code>Install</code> 버튼을 클릭하여 설치</li>
                        <li>IntelliJ IDEA 재시작</li>
                    </ol>
                </div>
                
                <h2>🔄 자동 업데이트 작동 방식</h2>
                <div class="update-info">
                    <p><strong>커스텀 저장소를 추가한 후:</strong></p>
                    <ol>
                        <li>새 버전이 릴리스되면 GitHub Pages가 자동으로 업데이트됩니다</li>
                        <li>IntelliJ가 주기적으로 플러그인 업데이트를 확인합니다</li>
                        <li>새 버전 발견 시 IDE 우측 하단에 알림이 나타납니다</li>
                        <li><code>Settings → Plugins → Updates</code>에서 수동으로도 확인 가능합니다</li>
                        <li>클릭 한 번으로 새 버전을 설치할 수 있습니다</li>
                    </ol>
                </div>
                
                <h2>⚙️ 설정 방법</h2>
                <p>설치 후 플러그인을 설정하세요:</p>
                <ol>
                    <li><code>File → Settings → Tools → Spectra Jira Settings</code>로 이동</li>
                    <li>Jira 서버 URL, 사용자명, API 토큰을 입력</li>
                    <li>연결을 테스트하고 저장</li>
                </ol>
                
                <h2>🔗 링크</h2>
                <ul>
                    <li><a href="https://github.com/${{ github.repository }}">📂 GitHub 저장소</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/releases">📦 모든 릴리스</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/issues">🐛 문제 신고</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/blob/main/README.md">📖 문서</a></li>
                </ul>
                
                <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #666; text-align: center;">
                    <p>Spectra Team에서 ❤️으로 제작 | 마지막 업데이트: ${{ steps.new_version.outputs.version }}</p>
                </footer>
            </div>
        </body>
        </html>
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v3
      with:
        enablement: true

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: gh-pages

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Success notification
      run: |
        echo "🎉 릴리스 완료!"
        echo "📌 새 버전: ${{ steps.new_version.outputs.version }}"
        echo "🔗 릴리스 페이지: https://github.com/${{ github.repository }}/releases/tag/${{ steps.new_version.outputs.tag }}"
        echo "🌐 플러그인 저장소: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "✅ IntelliJ 사용자들은 몇 분 내에 업데이트 알림을 받게 됩니다!"