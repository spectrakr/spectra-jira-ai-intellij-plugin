name: Version Bump and Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      custom_version:
        description: 'Custom version (optional, overrides version_type)'
        required: false
        type: string

jobs:
  version-bump-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Get current version
      id: current_version
      run: |
        CURRENT_VERSION=$(grep "^version = " build.gradle | sed "s/version = '//" | sed "s/'//")
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

    - name: Calculate new version
      id: new_version
      run: |
        CURRENT="${{ steps.current_version.outputs.current }}"
        
        if [ -n "${{ github.event.inputs.custom_version }}" ]; then
          NEW_VERSION="${{ github.event.inputs.custom_version }}"
          echo "Using custom version: $NEW_VERSION"
        else
          # Parse current version (assuming semantic versioning: x.y.z)
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          case "${{ github.event.inputs.version_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "Bumped ${{ github.event.inputs.version_type }} version: $NEW_VERSION"
        fi
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Update version in build.gradle
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.version }}"
        sed -i "s/^version = .*/version = '$NEW_VERSION'/" build.gradle
        echo "Updated build.gradle to version: $NEW_VERSION"

    - name: Update CHANGELOG.md
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.version }}"
        TODAY=$(date +%Y-%m-%d)
        
        # Create or update CHANGELOG.md
        if [ ! -f CHANGELOG.md ]; then
          cat > CHANGELOG.md << EOF
# Changelog

All notable changes to the Spectra IntelliJ AI Plugin will be documented in this file.

## [${NEW_VERSION}] - ${TODAY}

### Added
- Version ${NEW_VERSION} release

EOF
        else
          # Insert new version at the top of existing changelog
          sed -i "/^## \\[Unreleased\\]/a\\
\\
## [${NEW_VERSION}] - ${TODAY}\\
\\
### Added\\
- Version ${NEW_VERSION} release\\
" CHANGELOG.md
        fi

    - name: Commit version bump
      run: |
        NEW_VERSION="${{ steps.new_version.outputs.version }}"
        git add build.gradle CHANGELOG.md
        git commit -m "ğŸ”– Bump version to ${NEW_VERSION}
        
        - Updated build.gradle version
        - Updated CHANGELOG.md
        - Automated version bump via GitHub Actions"
        
        git push origin main

    - name: Create and push tag
      run: |
        TAG="${{ steps.new_version.outputs.tag }}"
        git tag -a "$TAG" -m "Release $TAG"
        git push origin "$TAG"

    - name: Cache Gradle wrapper
      uses: actions/cache@v4
      with:
        path: ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle-wrapper.properties') }}

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/daemon
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build plugin
      run: ./gradlew buildPlugin

    - name: Verify plugin
      run: ./gradlew verifyPlugin

    - name: Prepare plugin repository
      run: ./gradlew preparePluginRepository

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.new_version.outputs.tag }}
        name: Release ${{ steps.new_version.outputs.version }}
        body: |
          ## ğŸ‰ ë²„ì „ ${{ steps.new_version.outputs.version }} ë¦´ë¦¬ìŠ¤
          
          - í”ŒëŸ¬ê·¸ì¸ ë²„ì „: ${{ steps.new_version.outputs.version }}
          - IntelliJ IDEA ë¹Œë“œ 233 ~ 242.* ë²„ì „ê³¼ í˜¸í™˜
          - ìë™ ì—…ë°ì´íŠ¸ ì§€ì›
          
          ### ğŸ“¥ ì„¤ì¹˜ ë°©ë²• (ìë™ ì—…ë°ì´íŠ¸ ì§€ì›)
          
          1. IntelliJ IDEAë¥¼ ì—´ê³  `File â†’ Settings â†’ Plugins`ë¡œ ì´ë™
          2. âš™ï¸ í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ â†’ `Manage Plugin Repositories` í´ë¦­
          3. `+` ë²„íŠ¼ì„ í´ë¦­í•˜ê³  ë‹¤ìŒ URLì„ ì¶”ê°€:
             ```
             https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/updatePlugins.xml
             ```
          4. `OK` í´ë¦­
          5. `Marketplace` íƒ­ì—ì„œ "Spectra Jira AI" ê²€ìƒ‰ í›„ ì„¤ì¹˜
          
          ### âš™ï¸ ì„¤ì • ë°©ë²•
          ì„¤ì¹˜ í›„ `File â†’ Settings â†’ Tools â†’ Spectra Jira Settings`ì—ì„œ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì •í•˜ì„¸ìš”.
          
          ### ğŸ”„ ìë™ ì—…ë°ì´íŠ¸
          ì»¤ìŠ¤í…€ ì €ì¥ì†Œë¥¼ ì¶”ê°€í•œ ì‚¬ìš©ìëŠ” IntelliJì—ì„œ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì•Œë¦¼ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.
        draft: false
        prerelease: false
        files: |
          ./build/distributions/*.zip

    - name: Prepare GitHub Pages
      run: |
        mkdir -p gh-pages
        cp build/repository/updatePlugins.xml gh-pages/
        
        # Create index.html for repository info
        cat > gh-pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Spectra Jira AI IntelliJ í”ŒëŸ¬ê·¸ì¸ ì €ì¥ì†Œ</title>
            <meta charset="utf-8">
            <style>
                body { font-family: 'Malgun Gothic', Arial, sans-serif; margin: 40px; line-height: 1.6; }
                .container { max-width: 800px; margin: 0 auto; }
                code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; font-family: 'Monaco', 'Consolas', monospace; }
                .url { background: #e8f4fd; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0; border-left: 4px solid #2196F3; }
                .highlight { background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107; }
                h1 { color: #2196F3; }
                h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
                .method { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
                .note { background: #d4edda; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745; margin: 15px 0; }
                .update-info { background: #e3f2fd; padding: 15px; border-radius: 5px; border-left: 4px solid #2196f3; margin: 15px 0; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸš€ Spectra Jira AI IntelliJ í”ŒëŸ¬ê·¸ì¸ ì €ì¥ì†Œ</h1>
                
                <div class="highlight">
                    <strong>ğŸ“Œ ìµœì‹  ë²„ì „:</strong> ${{ steps.new_version.outputs.version }}
                </div>
                
                <div class="update-info">
                    <strong>ğŸ”„ ìë™ ì—…ë°ì´íŠ¸ í™œì„±í™”!</strong><br>
                    ì•„ë˜ ë°©ë²•ìœ¼ë¡œ ì„¤ì¹˜í•˜ë©´ ìƒˆ ë²„ì „ì´ ì¶œì‹œë  ë•Œë§ˆë‹¤ IntelliJì—ì„œ ìë™ìœ¼ë¡œ ì•Œë¦¼ì„ ë°›ìŠµë‹ˆë‹¤.
                </div>
                
                <div class="note">
                    <strong>ğŸ’¡ ê¶Œì¥ ì„¤ì¹˜ ë°©ë²•:</strong> ìë™ ì—…ë°ì´íŠ¸ë¥¼ ì§€ì›í•˜ëŠ” ì»¤ìŠ¤í…€ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                </div>
                
                <h2>ğŸ”§ ì„¤ì¹˜ ë°©ë²•</h2>
                
                <div class="method">
                    <h3>ì»¤ìŠ¤í…€ ì €ì¥ì†Œ ë°©ì‹ (ìë™ ì—…ë°ì´íŠ¸ ì§€ì›)</h3>
                    <ol>
                        <li>IntelliJ IDEAë¥¼ ì—´ê³  <code>File â†’ Settings â†’ Plugins</code>ë¡œ ì´ë™</li>
                        <li>âš™ï¸ í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ì„ í´ë¦­í•˜ê³  <code>Manage Plugin Repositories</code> ì„ íƒ</li>
                        <li><code>+</code> ë²„íŠ¼ì„ í´ë¦­í•˜ê³  ë‹¤ìŒ URLì„ ì¶”ê°€:</li>
                    </ol>
                    
                    <div class="url">
                        https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/updatePlugins.xml
                    </div>
                    
                    <ol start="4">
                        <li><code>OK</code> ë²„íŠ¼ í´ë¦­</li>
                        <li><code>Marketplace</code> íƒ­ì—ì„œ <strong>"Spectra Jira AI"</strong> ê²€ìƒ‰</li>
                        <li><code>Install</code> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„¤ì¹˜</li>
                        <li>IntelliJ IDEA ì¬ì‹œì‘</li>
                    </ol>
                </div>
                
                <h2>ğŸ”„ ìë™ ì—…ë°ì´íŠ¸ ì‘ë™ ë°©ì‹</h2>
                <div class="update-info">
                    <p><strong>ì»¤ìŠ¤í…€ ì €ì¥ì†Œë¥¼ ì¶”ê°€í•œ í›„:</strong></p>
                    <ol>
                        <li>ìƒˆ ë²„ì „ì´ ë¦´ë¦¬ìŠ¤ë˜ë©´ GitHub Pagesê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</li>
                        <li>IntelliJê°€ ì£¼ê¸°ì ìœ¼ë¡œ í”ŒëŸ¬ê·¸ì¸ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤</li>
                        <li>ìƒˆ ë²„ì „ ë°œê²¬ ì‹œ IDE ìš°ì¸¡ í•˜ë‹¨ì— ì•Œë¦¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</li>
                        <li><code>Settings â†’ Plugins â†’ Updates</code>ì—ì„œ ìˆ˜ë™ìœ¼ë¡œë„ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        <li>í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ìƒˆ ë²„ì „ì„ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                    </ol>
                </div>
                
                <h2>âš™ï¸ ì„¤ì • ë°©ë²•</h2>
                <p>ì„¤ì¹˜ í›„ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì •í•˜ì„¸ìš”:</p>
                <ol>
                    <li><code>File â†’ Settings â†’ Tools â†’ Spectra Jira Settings</code>ë¡œ ì´ë™</li>
                    <li>Jira ì„œë²„ URL, ì‚¬ìš©ìëª…, API í† í°ì„ ì…ë ¥</li>
                    <li>ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ê³  ì €ì¥</li>
                </ol>
                
                <h2>ğŸ”— ë§í¬</h2>
                <ul>
                    <li><a href="https://github.com/${{ github.repository }}">ğŸ“‚ GitHub ì €ì¥ì†Œ</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/releases">ğŸ“¦ ëª¨ë“  ë¦´ë¦¬ìŠ¤</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/issues">ğŸ› ë¬¸ì œ ì‹ ê³ </a></li>
                    <li><a href="https://github.com/${{ github.repository }}/blob/main/README.md">ğŸ“– ë¬¸ì„œ</a></li>
                </ul>
                
                <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #666; text-align: center;">
                    <p>Spectra Teamì—ì„œ â¤ï¸ìœ¼ë¡œ ì œì‘ | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${{ steps.new_version.outputs.version }}</p>
                </footer>
            </div>
        </body>
        </html>
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v3
      with:
        enablement: true

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: gh-pages

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Success notification
      run: |
        echo "ğŸ‰ ë¦´ë¦¬ìŠ¤ ì™„ë£Œ!"
        echo "ğŸ“Œ ìƒˆ ë²„ì „: ${{ steps.new_version.outputs.version }}"
        echo "ğŸ”— ë¦´ë¦¬ìŠ¤ í˜ì´ì§€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.new_version.outputs.tag }}"
        echo "ğŸŒ í”ŒëŸ¬ê·¸ì¸ ì €ì¥ì†Œ: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "âœ… IntelliJ ì‚¬ìš©ìë“¤ì€ ëª‡ ë¶„ ë‚´ì— ì—…ë°ì´íŠ¸ ì•Œë¦¼ì„ ë°›ê²Œ ë©ë‹ˆë‹¤!"